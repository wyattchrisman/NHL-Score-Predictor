---
title: "NHL-Score-Predictor-Final"
output: html_document
date: "2024-04-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      warning = F,
                      message = F)

# Load all needed packages
pacman::p_load(tidyverse, dplyr, ggfittext)

# Changing default themes
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = 0.5),
             plot.subtitle = element_text(hjust = 0.5))

# Changing the default choice for how many decimal places are displayed
options(digits = 4)
```

# Introduction

Wyatt TODO: ADD MORE - where datas from, what was cleaned

In the NHL, there are many ways for fans to bet on the games. One of those ways is guessing if the total number of goals scored by both teams is over or under a set line. This is known as the over/under and is normally denoted as O/U. The standard line for O/U is 5.5 goals. We will be using this metric for all of our data. The half a goal may be confusing, although this is because in hockey you can only score goals in 1s. So, if the total number of goals is \<5 the under will hit. And if the total is \>5 the over will hit. This allows every possible goal to have a result for the O/U.

## Getting Data

In the chunk below we will be getting all NHL games from the last 10 years in every game scenario, (even strength, power play, penalty kill, etc.) and will be trimming this data so we get the statistics from each game in all scenario.

```{r Getting Data}
# Get all NHL data from 2008 on
all_years_data <- 
  read.csv(url("https://wchrisma.w3.uvm.edu/DS-data/all_teams.csv")) 
  
# Clip data to be >2013 and all situations
data <-
  all_years_data |>
  filter(season > 2013) |>
  filter(situation == 'all')

# Select all columns wanted for graphs
data <- 
  data |>
  dplyr::select(team, season, opposingTeam:gameDate, xGoalsFor, shotsOnGoalFor, shotAttemptsFor, goalsFor, takeawaysFor, giveawaysFor, lowDangerShotsFor:highDangerShotsFor, lowDangerGoalsFor:highDangerGoalsFor,xGoalsAgainst, shotsOnGoalAgainst, shotAttemptsAgainst, goalsAgainst, takeawaysAgainst, giveawaysAgainst, lowDangerGoalsAgainst:highDangerGoalsAgainst) |>
  mutate(totalGoals = goalsAgainst + goalsFor) |>
  mutate(totalShots = shotsOnGoalAgainst + shotsOnGoalFor) |>
  mutate(
    OU = if_else(
      totalGoals < 5,
      "Under",
      "Over"
    )
  ) |>
  mutate(
    team = if_else(team == "T.B", "TBL", team)
  ) |>
  mutate(
    team = if_else(team == "N.J", "NJD", team)
  ) |>
  mutate(
    team = if_else(team == "L.A", "LAK", team)
  ) |>
  mutate(
    team = if_else(team == "S.J", "SJS", team)
  )
  

# Move totalGoals and OU closer to front of dataframe for readability
cols_to_move <- 
  data |>
  select(totalGoals, OU, totalShots)

#slicing first half for column partitioning
df_without_last_cols <- 
  data |>
  select(team:highDangerGoalsAgainst)

#where to index column
insert_position <- 5
data <- cbind(
  df_without_last_cols[, 1:insert_position], 
  cols_to_move, 
  df_without_last_cols[, (insert_position + 1):ncol(df_without_last_cols)]
)

# Sort by most recent games with date
data <-
  data[order(data$gameDate, decreasing = T), ]

# Remove data not used again
rm(cols_to_move, df_without_last_cols, insert_position)

# Preview vector
tibble(data)
```

## Average goals/game of each team in 2023
```{r Average goals Graph}
# Vector holding all the team colors
team_colors <- c("ANA" = "#F47A38",
                 "ARI" = "#8C2633",
                 "BOS" = "#FFB81C",
                 "BUF" = "#003087",
                 "CGY" = "#D2001C", 
                 "CAR" = "#CE1126", 
                 "CHI" = "#CF0A2C", 
                 "COL" = "#6F263D", 
                 "CBJ" = "#002654", 
                 "DAL" = "#006847", 
                 "DET" = "#CE1126", 
                 "EDM" = "#FF4C00",
                 "FLA" = "#041E42", 
                 "LAK" = "#111111", 
                 "MIN" = "#154734", 
                 "MTL" = "#AF1E2D", 
                 "NSH" = "#041E42", 
                 "NJD" = "#CE1126", 
                 "NYI" = "#00539B",
                 "NYR" = "#0038A8",
                 "OTT" = "#000000",  
                 "PHI" = "#F74902", 
                 "PIT" = "#FCB514", 
                 "SJS" = "#006D75",
                 "SEA" = "#99D9D9",
                 "STL" = "#002F87",
                 "TBL" = "#002868",
                 "TOR" = "#00205B",
                 "VAN" = "#00205B",
                 "VGK" = "#B4975A",
                 "WSH" = "#C8102E",
                 "WPG" = "#041E42")

# Group by team and season, then summarize to calculate the mean goals per game
average_goals_data <- 
  data |>
  filter(season == 2023) |>
  group_by(team) |>
  summarize(average_goals = mean(totalGoals))

#Using ggplot to create a bar chart
ggplot(
  data = average_goals_data, 
  mapping = aes(
    x = reorder(team, average_goals), 
    y = average_goals
  )
) +
  geom_bar(
    stat = "identity", 
    aes(fill = team)
  ) +
  scale_fill_manual(values = team_colors) +
  geom_hline(
    yintercept = 5.5, 
    linetype = "dashed", 
    color = "white"
  ) +
  scale_y_continuous(
     expand = c(0,0,0.05,0),
     breaks = c(1,2,3,4,5.5,7)
) + 
  labs(title = "Average Total Goals per Game for the 2023 Season",
       x = "Team",
       y = "Average Goals per Game") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 65, vjust = 1, hjust=1)
  ) 
```

ADD GRAPH DESCRIPTION

## Over Under Probability Graph
```{r Over Under Probability Graph}
# Get the over percentage of each team
team_OU_percent <-
  data |>
  filter(season == 2023) |>
  group_by(team) |>
  mutate(under_percent = sum(OU == "Under", na.rm = T) / sum(!is.na(OU))) |>
  select(under_percent, OU) 

# Arrange the over percentages in descending order
team_OU_percent <-
  team_OU_percent[order(team_OU_percent$under_percent, decreasing = F), ]

# Create graph
ggplot(
  data = team_OU_percent,
  mapping = aes(
    x = reorder(team, under_percent),
    y = under_percent,
    fill = factor(OU)
  )
) +
  # Set type of graph
  geom_col(
    position = "fill"
  ) + 
  
  #Add percentages to top of
  geom_text(
    mapping = aes(
      label = round(under_percent,2)*100
    ),
    vjust = 2, 
    color = "black",
    size = 3
  ) +

  # Set colors of fill
  scale_fill_manual(
    values = c(
      "Over" = "#76b5c5",
      "Under" = "#e28743"
    ),
  ) + 
  # Create labels for graph
  labs(
    x = "NHL Teams",
    title = "NHL Team Over/Under Probabilities (%) in 2023"
  ) + 
  # Set graph to have minimal white-space and add percentages
  scale_y_continuous(
    expand = c(0,0,0.05,-0.05),
    labels = scales::label_percent()
  ) +
  # Set legend title blank and legend to bottom
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 65, vjust = 1, hjust=1)
  ) 
```
Wyatt TODO: Add graph description, change color, sort

## Graph2 - See how higher total shots correlate to over
```{r total shot scatterplot}
# subsetting for total shot
total_shot_data <- 
  data |> 
  # remove duplicate games
  filter(home_or_away == "HOME") |>
  #combing for the columns we'll be using
  select(team, totalShots, OU, shotsOnGoalFor, shotsOnGoalAgainst, goalsFor) 
  
#ggplot graph for comparing shots   
shot_scatterplot <-
  ggplot(data = total_shot_data,
         mapping = aes(
           x = shotsOnGoalFor,
           y = shotsOnGoalAgainst,
           color = OU
         )
         ) +
  geom_point(
    #using jitter to make the density of points more visible 
    position=position_jitter(h=0.15,w=0.15)
  )+
  #choosing colors for the over vs under value
  scale_color_manual(
    values = c(
      "Over" = "#3e9c35",
      "Under" = "#FF0000"
    )
  ) + 
  labs(
    x = "Shots Taken",
    y = "Shots Against",
    color = ""
  )

shot_scatterplot
```
ADD GRAPH DECRIPTION

## Low, Medium, High Danger Shots to Goals
```{r L/M/H Danger shots}
LMH_data <-
  data |>
  filter(season == 2023) |>
  select(team:gameDate, OU, shotsOnGoalFor, goalsFor,lowDangerShotsFor:highDangerGoalsFor)

LMH_data_long <- 
  LMH_data |>
  pivot_longer(cols = c(lowDangerShotsFor, mediumDangerShotsFor, highDangerShotsFor),
               names_to = "shotType",
               values_to = "shots")

ggplot(
  data = LMH_data_long, 
  mapping = aes(x = shots, 
                y = goalsFor)) +
  geom_boxplot() +
  facet_wrap(~shotType, scales = "free_x", ncol = 1) +
  labs(x = "Shots", y = "Goals")
   
#tibble(LMH_data)
```
