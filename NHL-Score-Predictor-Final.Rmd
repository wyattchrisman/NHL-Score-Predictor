---
title: "NHL-Score-Predictor-Final"
output: html_document
date: "2024-04-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load all needed packages
pacman::p_load(tidyverse, dplyr)

# Changing default themes
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = 0.5),
             plot.subtitle = element_text(hjust = 0.5))

# Changing the default choice for how many decimal places are displayed
options(digits = 4)
```

# Introduction

Wyatt TODO: ADD MORE - where datas from, what was cleaned

In the NHL, there are many ways for fans to bet on the games. One of those ways is guessing if the total number of goals scored by both teams is over or under a set line. This is known as the over/under and is normally denoted as O/U. The standard line for O/U is 5.5 goals. We will be using this metric for all of our data. The half a goal may be confusing, although this is because in hockey you can only score goals in 1s. So, if the total number of goals is \<5 the under will hit. And if the total is \>5 the over will hit. This allows every possible result of the game goal wise to have a result for the O/U.

## Getting Data

In the chunk below we will be getting all NFL games from the last 5 games in every game scenario, (even strength, power play, penalty kill, etc.) and will be trimming this data so we get the statistics from each game in all scenario.

```{r Getting Data}
# Get all NHL data from 2008 on
all_years_data <- 
  read.csv(url("https://moneypuck.com/moneypuck/playerData/careers/gameByGame/all_teams.csv")) 
  
# Clip data to be >2014 and all situations
data <-
  all_years_data |>
  filter(season > 2013) |>
  filter(situation == 'all')

# Select all columns wanted for graphs
data <- 
  data |>
  dplyr::select(team, season, opposingTeam:gameDate, xGoalsFor, shotsOnGoalFor, shotAttemptsFor, goalsFor, takeawaysFor, giveawaysFor, lowDangerShotsFor:highDangerShotsFor, lowDangerGoalsFor:shotsOnGoalAgainst, xGoalsAgainst, shotsOnGoalAgainst, shotAttemptsAgainst, goalsAgainst, takeawaysAgainst, giveawaysAgainst, lowDangerGoalsAgainst:highDangerGoalsAgainst) |>
  mutate(totalGoals = goalsAgainst + goalsFor) |>
  mutate(totalShots = shotsOnGoalAgainst + shotsOnGoalFor) |>
  mutate(
    OU = if_else(
      totalGoals < 5,
      "Under",
      "Over"
    )
  )

# Move totalGoals and OU closer to front of dataframe for readability
cols_to_move <- 
  data |>
  select(totalGoals, OU, totalShots)

df_without_last_cols <- 
  data |>
  select(team:highDangerGoalsAgainst)

insert_position <- 5
data <- cbind(df_without_last_cols[, 1:insert_position], cols_to_move, df_without_last_cols[, (insert_position + 1):ncol(df_without_last_cols)])

# Sort by most recent games with date
data <-
  data[order(data$gameDate, decreasing = T), ]

# Get teams individual data
#summarize(data)

# Remove data not used again
rm(cols_to_move, df_without_last_cols, insert_position)

# Preview vector
tibble(data)
```

## Over Under Probability Graph

```{r Over Under Probability Graph}
# Get the over percentage of each team
team_OU_percent <-
  data |>
  group_by(team) |>
  mutate(over_percent = sum(OU == "Over", na.rm = T)/ sum(!is.na(OU))) |>
  select(over_percent, OU) 

# Arrange the over percentages in descending order
team_OU_percent <-
team_OU_percent[order(team_OU_percent$over_percent, decreasing = F), ]


# Create graph
ggplot(
  data = team_OU_percent,
  mapping = aes(
    y = reorder(team, over_percent),
    fill = OU
  )
)+
# Set type of graph
 geom_bar(
  position = "fill"
) + 
  # Set colors of fill
  scale_fill_manual(
    values = c(
      "Over" = "#006847",
      "Under" = "#8F8F8C"
    ),
    # Reverse order of key
    guide = guide_legend(reverse = TRUE)
  ) + 
  # Create labels for graph
  labs(
    y = "NHL Teams",
    title = "NHL Team O/U Probablities"
  ) + 
  # Set graph to have minimal whitespace on sides and add percentages
  scale_x_continuous(
    expand = c(0,0,0.05,-0.04),
    labels = scales::label_percent()
  ) +
  # Set legend title blank and legend to bottom
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) 


```

Wyatt TODO: Add graph description, change color, sort

## Graph2 - See if higher total shots cause over

## Graph3 - Same as above with low, medium, high danger shots - could use facet wrap

## Graph4 -
